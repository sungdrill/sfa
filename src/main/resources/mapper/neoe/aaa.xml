<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cellbiotech.mapper.neoe.PartnerMapper">
    <select id="selectPartnerListCount" parameterType="Map" resultType="int">
        SELECT 'N' AS S,
        P.CD_ITEM,
        ISNULL(P.NM_ITEM, '') NM_ITEM,
        ISNULL(P.STND_ITEM, '') STND_ITEM,
        ISNULL(P.BARCODE, '') BARCODE,
        P.FG_ABC, --색깔구별컬럼
        'FALSE' AS FG_VAL,        -- 금액이 0이면 0 그렇지 않으면 1 (금액이 모두 0인것은 필터처리하기위함)

        ISNULL(MC1.NM_SYSDEF, '') AS NM_CLS_L,
        ISNULL(MC2.NM_SYSDEF, '') AS NM_CLS_M,
        ISNULL(MC3.NM_SYSDEF, '') AS NM_CLS_S, -- 20090210 추가
        ISNULL(P.CD_ZONE,'') AS CD_ZONE,  -- 2011/01/31 컬럼 추가
        ISNULL(E1.NM_KOR,'') AS NM_KOR1,  -- 관리자 1
        ISNULL(E2.NM_KOR,'') AS NM_KOR2,  -- 관리자 2
        ISNULL(MC4.NM_SYSDEF, '') AS CLS_ITEM,    -- 계정구분
        ISNULL(MC6.NM_SYSDEF, '' ) AS NM_GRP_MFG, -- 제품군 컬럼 추가  2011.04.05 (송철호)
        ISNULL(MC5.NM_SYSDEF, '' ) AS NM_TP_ITEM, -- 품목타입 컬럼 추가 2011-03-31 (송철호)
        ISNULL(MI.NM_ITEMGRP, '' ) AS NM_ITEMGRP, -- 품목군 컬럼 추가 2011-03-31 (송철호)
        CASE WHEN P.FG_SERNO = '001' THEN 'NO' ELSE ISNULL(MC7.NM_SYSDEF, '') END FG_SERNO, -- S/N,LOT관리 컬럼추가 2011.05.12 (최규원)영문화 작업으로 인해 미관리를 'NO'로 교체
        ISNULL(MG.NM_PURGRP,'') AS NM_PURGRP,   /*품목 구매그룹*/

        CASE WHEN   ( @P_YN_PJT_SUM = 'N')    THEN ISNULL( X.CD_PJT ,'')     ELSE '' END  AS  CD_PJT
        ,  CASE WHEN ( @P_YN_PJT_SUM = 'N') THEN  ISNULL( SP.NM_PROJECT, '')   ELSE '' END AS NM_PJT
        ,  CASE WHEN ( @V_YN_UNIT = 'Y' )  AND (@P_YN_PJT_SUM ='N')  THEN ISNULL(X.SEQ_PROJECT,0)  ELSE 0  END  AS  SEQ_PROJECT,

        ISNULL(P.EN_ITEM,'') AS EN_ITEM,
        ISNULL(P.STND_DETAIL_ITEM,'') STND_DETAIL_ITEM,
        ISNULL(P.MAT_ITEM,'') MAT_ITEM,
        CASE WHEN ( @P_YN_PJT_SUM = 'N') THEN  ISNULL(P2.CD_ITEM,'') ELSE '' END   AS CD_PJT_ITEM,
        CASE WHEN ( @P_YN_PJT_SUM = 'N') THEN  ISNULL(P2.NM_ITEM,'') ELSE '' END   AS NM_PJT_ITEM,
        CASE WHEN ( @P_YN_PJT_SUM = 'N') THEN  ISNULL(P2.STND_ITEM,'') ELSE '' END   AS PJT_ITEM_STND,
        ISNULL(P.NO_DESIGN,'') AS NO_DESIGN,
        ISNULL(P.QT_SSTOCK, 0) AS QT_SSTOCK,
        ISNULL(P.TP_PROC,'') AS TP_PROC,
        ISNULL(MP2.LN_PARTNER,'') AS PARTNER,
        ISNULL(P.FG_GIR,'') AS FG_GIR,
        /*신규 컬럼추가시 아래의 UNIT_IM , NM_SL, QT_INV 은 항상 맨 하단에 존재해야합니다*/
        ISNULL(P.UNIT_IM, '') UNIT_IM,
        CASE WHEN S.NM_SL IS NULL THEN X.CD_SL ELSE S.NM_SL END NM_SL,
        X.QT_INV

        FROM DZSN_MA_PITEM P    LEFT OUTER JOIN
        (
        SELECT CD_SL, CD_ITEM, QT_GOOD_INV QT_INV
        , CASE WHEN   (@V_YN_PJT = 'Y')   THEN CD_PJT ELSE '' END  CD_PJT
        , CASE  WHEN  (@V_YN_PJT = 'Y')   AND (@V_YN_UNIT = 'Y')   THEN  SEQ_PROJECT  ELSE 0 END   SEQ_PROJECT

        FROM MM_OPENQTL
        WHERE CD_COMPANY = @P_CD_COMPANY
        AND  CD_PLANT = @P_CD_PLANT
        AND  YM_STANDARD = LEFT(@P_DT, 4) + '00'
        AND  (CD_ITEM >= @P_ITEM_FROM OR @P_ITEM_FROM = '' OR @P_ITEM_FROM IS NULL)
        AND  (CD_ITEM <= @P_ITEM_TO OR @P_ITEM_TO = '' OR @P_ITEM_TO IS NULL)
        AND (CD_PJT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_PJT)) OR @P_MULTI_CD_PJT = '' OR @P_MULTI_CD_PJT IS NULL)

        UNION ALL

        SELECT CD_SL, CD_ITEM,
        SUM(QT_GOOD_GR + QT_REJECT_GR + QT_INSP_GR + QT_TRANS_GR) - SUM(QT_GOOD_GI + QT_REJECT_GI + QT_INSP_GI + QT_TRANS_GI) QT_INV
        , CASE WHEN   (@V_YN_PJT = 'Y')   THEN CD_PJT ELSE '' END  CD_PJT
        , CASE  WHEN  (@V_YN_PJT = 'Y')   AND (@V_YN_UNIT = 'Y')   THEN  SEQ_PROJECT  ELSE 0 END   SEQ_PROJECT

        FROM MM_OHSLINVM
        WHERE CD_COMPANY = @P_CD_COMPANY
        AND  YM_IO >= LEFT(@P_DT, 4) + '00'
        AND  YM_IO <= LEFT(@P_DT, 6) - 1
        AND  CD_PLANT = @P_CD_PLANT
        AND  (CD_ITEM >= @P_ITEM_FROM OR @P_ITEM_FROM = '' OR @P_ITEM_FROM IS NULL)
        AND  (CD_ITEM <= @P_ITEM_TO OR @P_ITEM_TO = '' OR @P_ITEM_TO IS NULL)
        AND (CD_PJT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_PJT)) OR @P_MULTI_CD_PJT = '' OR @P_MULTI_CD_PJT IS NULL)

        GROUP BY CD_SL , CD_ITEM
        , CASE WHEN   (@V_YN_PJT = 'Y')   THEN CD_PJT ELSE '' END
        , CASE  WHEN  (@V_YN_PJT = 'Y')   AND (@V_YN_UNIT = 'Y')   THEN  SEQ_PROJECT  ELSE 0 END


        UNION ALL

        SELECT   L.CD_SL, L.CD_ITEM,
        L.QT_GOOD_GR - L.QT_GOOD_GI + L.QT_REJECT_GR - L.QT_REJECT_GI + L.QT_TRANS_GR - L.QT_TRANS_GI + L.QT_INSP_GR - L.QT_INSP_GI  QT_INV
        , CASE WHEN   (@V_YN_PJT = 'Y')   THEN L.CD_PJT ELSE '' END  CD_PJT
        , CASE  WHEN  (@V_YN_PJT = 'Y')   AND (@V_YN_UNIT = 'Y')   THEN  L.SEQ_PROJECT  ELSE 0 END   SEQ_PROJECT

        FROM MM_OHSLINVD  L
        INNER JOIN DZSN_MA_PITEM P ON P.CD_COMPANY = @P_CD_COMPANY AND P.CD_PLANT = @P_CD_PLANT AND P.CD_ITEM = L.CD_ITEM AND
        ((@P_YN_USE_PITEM = 'Y' AND P.YN_USE = 'Y') OR (@P_YN_USE_PITEM = 'N' AND (P.YN_USE = 'Y' OR P.YN_USE = 'N' OR ISNULL(P.YN_USE ,'') = '' ))) AND
        --(P.CLS_ITEM = @P_CLS_ITEM OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL) AND
        (P.CLS_ITEM IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CLS_ITEM)) OR @P_MULTI_CLS_ITEM = '' OR @P_MULTI_CLS_ITEM IS NULL)
        AND (P.FG_ABC = @P_FG_ABC OR @P_FG_ABC = '' OR @P_FG_ABC IS NULL) AND
        (P.GRP_ITEM = @P_GRP_ITEM OR @P_GRP_ITEM = '' OR @P_GRP_ITEM IS NULL)
        WHERE L.CD_COMPANY = @P_CD_COMPANY
        AND  L.CD_PLANT = @P_CD_PLANT
        AND  L.DT_IO <= @P_DT
        AND  L.DT_IO > LEFT(@P_DT, 6) + '00'
        AND  (L.CD_ITEM >= @P_ITEM_FROM OR @P_ITEM_FROM = '' OR @P_ITEM_FROM IS NULL)
        AND  (L.CD_ITEM <= @P_ITEM_TO OR @P_ITEM_TO = '' OR @P_ITEM_TO IS NULL)
        AND (CD_PJT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_PJT)) OR @P_MULTI_CD_PJT = '' OR @P_MULTI_CD_PJT IS NULL)

        ) X ON P.CD_COMPANY = @P_CD_COMPANY AND P.CD_PLANT = @P_CD_PLANT AND P.CD_ITEM = X.CD_ITEM
        AND ((@P_YN_USE_PITEM = 'Y' AND P.YN_USE = 'Y') OR (@P_YN_USE_PITEM = 'N' AND (P.YN_USE = 'Y' OR P.YN_USE = 'N' OR ISNULL(P.YN_USE ,'') = '' )))
        --AND (P.CLS_ITEM = @P_CLS_ITEM OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL)
        AND (P.CLS_ITEM IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CLS_ITEM)) OR @P_MULTI_CLS_ITEM = '' OR @P_MULTI_CLS_ITEM IS NULL)
        AND (P.FG_ABC = @P_FG_ABC OR @P_FG_ABC = '' OR @P_FG_ABC IS NULL)
        AND (P.GRP_ITEM = @P_GRP_ITEM OR @P_GRP_ITEM = '' OR @P_GRP_ITEM IS NULL)
        LEFT OUTER JOIN DZSN_MA_SL S ON S.CD_COMPANY = @P_CD_COMPANY AND S.CD_BIZAREA = @CD_BIZAREA AND S.CD_PLANT = @P_CD_PLANT AND S.CD_SL = X.CD_SL
        LEFT OUTER JOIN DZSN_MA_CODEDTL MC1 ON P.CD_COMPANY = MC1.CD_COMPANY AND MC1.CD_FIELD = 'MA_B000030' AND P.CLS_L = MC1.CD_SYSDEF
        LEFT OUTER JOIN DZSN_MA_CODEDTL MC2 ON P.CD_COMPANY = MC2.CD_COMPANY AND MC2.CD_FIELD = 'MA_B000031' AND P.CLS_M = MC2.CD_SYSDEF
        LEFT OUTER JOIN DZSN_MA_CODEDTL MC3 ON P.CD_COMPANY = MC3.CD_COMPANY AND MC3.CD_FIELD = 'MA_B000032' AND P.CLS_S = MC3.CD_SYSDEF
        LEFT OUTER JOIN DZSN_MA_CODEDTL MC4 ON P.CD_COMPANY = MC4.CD_COMPANY AND MC4.CD_FIELD = 'MA_B000010' AND P.CLS_ITEM = MC4.CD_SYSDEF
        LEFT OUTER JOIN DZSN_MA_CODEDTL MC5 ON P.CD_COMPANY = MC5.CD_COMPANY AND MC5.CD_FIELD = 'MA_B000011' AND P.TP_ITEM = MC5.CD_SYSDEF
        LEFT OUTER JOIN DZSN_MA_CODEDTL MC6 ON P.CD_COMPANY = MC6.CD_COMPANY AND MC6.CD_FIELD = 'MA_B000066' AND P.GRP_MFG = MC6.CD_SYSDEF
        LEFT OUTER JOIN DZSN_MA_CODEDTL MC7 ON P.CD_COMPANY = MC7.CD_COMPANY AND MC7.CD_FIELD = 'MA_B000015' AND P.FG_SERNO = MC7.CD_SYSDEF
        LEFT OUTER JOIN DZSN_MA_EMP E1 ON P.CD_COMPANY = E1.CD_COMPANY AND P.NO_MANAGER1 = E1.NO_EMP
        LEFT OUTER JOIN DZSN_MA_EMP E2 ON P.CD_COMPANY = E2.CD_COMPANY AND P.NO_MANAGER2 = E2.NO_EMP
        LEFT OUTER JOIN DZSN_MA_ITEMGRP MI ON P.GRP_ITEM = MI.CD_ITEMGRP AND P.CD_COMPANY = MI.CD_COMPANY
        LEFT OUTER JOIN DZSN_MA_PURGRP  MG ON P.CD_COMPANY = MG.CD_COMPANY AND P.CD_PURGRP = MG.CD_PURGRP
        LEFT OUTER JOIN DZSN_SA_PROJECTH SP ON  SP.CD_COMPANY = @P_CD_COMPANY  AND X.CD_PJT = SP.NO_PROJECT
        LEFT OUTER JOIN SA_PROJECTL SPL ON SPL.CD_COMPANY = @P_CD_COMPANY AND SPL.NO_PROJECT = X.CD_PJT AND SPL.SEQ_PROJECT = X.SEQ_PROJECT
        LEFT OUTER JOIN DZSN_MA_PITEM P2 ON P2.CD_COMPANY = SPL.CD_COMPANY AND P2.CD_PLANT = SPL.CD_PLANT AND P2.CD_ITEM = SPL.CD_ITEM
        LEFT OUTER JOIN DZSN_MA_PARTNER MP2 ON MP2.CD_COMPANY = P.CD_COMPANY AND MP2.CD_PARTNER = P.PARTNER

        WHERE P.CD_COMPANY = @P_CD_COMPANY
        AND  P.CD_PLANT = @P_CD_PLANT
        AND  ((@P_YN_USE_PITEM = 'Y' AND P.YN_USE = 'Y') OR @P_YN_USE_PITEM = 'N')
        --AND  (P.CLS_ITEM = @P_CLS_ITEM OR @P_CLS_ITEM = '' OR @P_CLS_ITEM IS NULL)
        AND (P.CLS_ITEM IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CLS_ITEM)) OR @P_MULTI_CLS_ITEM = '' OR @P_MULTI_CLS_ITEM IS NULL)
        AND  (P.CD_ITEM >= @P_ITEM_FROM OR @P_ITEM_FROM = '' OR @P_ITEM_FROM IS NULL)
        AND  (P.CD_ITEM <= @P_ITEM_TO OR @P_ITEM_TO = '' OR @P_ITEM_TO IS NULL)
        AND  (P.FG_ABC = @P_FG_ABC OR @P_FG_ABC = '' OR @P_FG_ABC IS NULL)
        AND  (P.GRP_ITEM = @P_GRP_ITEM OR @P_GRP_ITEM = '' OR @P_GRP_ITEM IS NULL)
        AND  (@P_CLS_L_MULTI IS NULL OR @P_CLS_L_MULTI = '' OR P.CLS_L IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CLS_L_MULTI)))
        AND  (@P_CLS_M_MULTI IS NULL OR @P_CLS_M_MULTI = '' OR P.CLS_M IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CLS_M_MULTI)))
        AND  (@P_CLS_S_MULTI IS NULL OR @P_CLS_S_MULTI = '' OR P.CLS_S IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_CLS_S_MULTI)))
        AND ((@V_EXC_CLS_YN = '000' AND (P.CLS_ITEM IN ('001', '002', '003', '004', '005', '009')))
        OR(@V_EXC_CLS_YN = '100')) --20090506 수불계정만 해당하게 수정
        AND  (@P_MULTI_CD_SL IS NULL OR @P_MULTI_CD_SL = '' OR X.CD_SL IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_SL)))
        AND  (@P_MULTI_GRP_MFG = '' OR @P_MULTI_GRP_MFG IS NULL OR P.GRP_MFG IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_GRP_MFG)))
        AND     (@P_MULTI_TP_ITEM IS NULL OR @P_MULTI_TP_ITEM = '' OR P.TP_ITEM IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_TP_ITEM)))
        AND ( P.CD_PURGRP  =  @P_CD_PURGRP OR   @P_CD_PURGRP IS NULL OR @P_CD_PURGRP = '')
        AND (X.CD_PJT IN (SELECT CD_STR FROM GETTABLEFROMSPLIT(@P_MULTI_CD_PJT)) OR @P_MULTI_CD_PJT = '' OR @P_MULTI_CD_PJT IS NULL)
        AND (P.TP_PROC = @P_TP_PROC OR @P_TP_PROC IS NULL OR @P_TP_PROC = '')
        AND (P.FG_GIR = @P_FG_GIR OR @P_FG_GIR IS NULL OR @P_FG_GIR = '')
        --ORDER BY X.CD_ITEM, X.CD_SL
    </select>
</mapper>